<!DOCTYPE html>
<html>
<head>
    <title>バーコードスキャン</title>
    <script src="{{ url_for('static', filename='quagga.min.js') }}"></script>
</head>
<body>
    <h2>リアルタイムバーコードスキャン</h2>
    <div id="scanner-container" style="width:400px; height:300px;"></div>
    <p id="status">スキャン待ち...</p>

    <script>
    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector('#scanner-container'),
            constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
    }, function(err) {
        if(err){ console.error(err); return; }
        Quagga.start();
    });

    Quagga.onDetected(function(result){
        const code = result.codeResult.code;
        document.getElementById("status").innerText = "検出: " + code;

        // Flask に自動送信
        fetch("/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ "barcode": code })
        })
        .then(resp => resp.json())
        .then(data => {
            console.log(data);
            document.getElementById("status").innerText = 
                `バーコード ${data.barcode} ${data.action}`;
        });
    });
    </script>
</body>
</html>
