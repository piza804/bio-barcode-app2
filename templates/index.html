<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>バーコードスキャン</title>
    <script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
</head>
<body>
    <h1>バーコードスキャン</h1>
    <div id="scanner" style="width:400px; height:300px;"></div>
    <p id="result">バーコード未検出</p>

    <script>
    Quagga.init({
        inputStream: { 
            type : "LiveStream",
            constraints: { facingMode: "environment" },
            target: document.querySelector('#scanner')
        },
        decoder : { readers : ["code_128_reader","ean_reader","upc_reader"] }
    }, function(err) {
        if (err) console.log(err);
        else Quagga.start();
    });

    Quagga.onDetected(function(data){
        const code = data.codeResult.code;
        document.getElementById("result").textContent = "検出: " + code;

        // FlaskにPOST
        fetch("/scan", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ barcode: code })
        })
        .then(res => res.json())
        .then(resp => {
            console.log(resp);
            alert(`バーコード: ${resp.barcode}\nアクション: ${resp.action}`);
        })
        .catch(err => console.error(err));
    });
    </script>
</body>
</html>
